<!DOCTYPE html>
<!--
NerdCam Viewer - Foscam R2 camera control and live view.
All requests go through local proxy (same origin, no CORS).
Served by nerdcam.py proxy server.
-->
<html>
<head>
<meta charset="UTF-8">
<title>NerdCam Viewer</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: #1a1a2e;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
}
#topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: #16213e;
    border-bottom: 2px solid #0f3460;
}
#topbar h1 { font-size: 1.1em; color: #e94560; }
.live { color: #2ecc71; font-weight: bold; font-size: 0.85em; }
.stopped { color: #e74c3c; font-weight: bold; font-size: 0.85em; }
#main { display: flex; flex: 1; overflow: hidden; }
#viewer {
    flex: 1; display: flex; align-items: center;
    justify-content: center; background: #000;
}
#viewer img { max-width: 100%; max-height: 100%; object-fit: contain; }
#sidebar {
    width: 280px; background: #16213e; padding: 12px;
    display: flex; flex-direction: column; gap: 8px;
    border-left: 2px solid #0f3460; overflow-y: auto;
}
.panel h3 {
    font-size: 0.78em; color: #e94560; margin-bottom: 5px;
    text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
    user-select: none;
}
.panel h3:hover { color: #fff; }
.panel h3::before { content: "\25BE "; margin-right: 4px; }
.panel.collapsed .panel-body { display: none; }
.panel.collapsed h3::before { content: "\25B8 "; }
#ptz {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 3px; max-width: 180px;
}
#ptz button {
    width: 100%; aspect-ratio: 1; border: 1px solid #0f3460;
    background: #1a1a2e; color: #eee; font-size: 1.3em;
    cursor: pointer; border-radius: 4px;
}
#ptz button:hover { background: #e94560; }
#ptz button:active { background: #c0392b; }
#ptz button.home { background: #0f3460; font-size: 0.6em; }
.btn {
    padding: 4px 8px; border: 1px solid #0f3460; background: #0f3460;
    color: #eee; border-radius: 4px; cursor: pointer;
    font-size: 0.75em; width: 100%; margin-top: 2px;
}
.btn:hover { background: #e94560; border-color: #e94560; }
.btn.danger { background: #c0392b; border-color: #c0392b; }
.btn.active { background: #2ecc71; border-color: #2ecc71; }
.btn-row { display: flex; gap: 3px; }
.btn-row .btn { flex: 1; }
.slider-row {
    display: flex; align-items: center; gap: 5px; margin: 3px 0;
}
.slider-row label { font-size: 0.68em; color: #7f8c8d; width: 65px; }
.slider-row input[type=range] { flex: 1; accent-color: #e94560; }
.slider-row .val { font-size: 0.68em; width: 25px; text-align: right; }
.setting { display: flex; align-items: center; gap: 5px; margin: 3px 0; }
.setting label { font-size: 0.68em; color: #7f8c8d; width: 85px; }
.setting input, .setting select {
    background: #1a1a2e; border: 1px solid #0f3460; color: #eee;
    padding: 2px 5px; border-radius: 3px; font-size: 0.75em; width: 75px;
}
#output {
    font-family: monospace; font-size: 0.62em; background: #0d0d1a;
    border: 1px solid #0f3460; border-radius: 4px; padding: 6px;
    height: 130px; overflow-y: auto; white-space: pre-wrap;
    word-break: break-all; color: #7f8c8d;
}
</style>
<script>
var C = { ptzDur: 500 };
var viewerTask = null;

// All requests go through local proxy -- no CORS issues
function send(cmd, extra, callback) {
    var url = "/api/cam?cmd=" + cmd;
    if (extra) url += "&" + extra;
    fetch(url).then(function(r) { return r.text(); }).then(function(text) {
        // Parse XML response
        var parser = new DOMParser();
        var xml = parser.parseFromString(text, "text/xml");
        var result = {};
        var nodes = xml.documentElement.children;
        var lines = [];
        for (var i = 0; i < nodes.length; i++) {
            var key = nodes[i].tagName;
            var val = nodes[i].textContent || "";
            result[key] = val;
            if (key !== "result") lines.push(key + ": " + decodeURIComponent(val));
        }
        log(cmd + " (result=" + (result.result||"?") + "):\n" + lines.join("\n"));
        if (callback) callback(result);
    }).catch(function(e) {
        log(cmd + ": ERROR " + e);
    });
}

function log(msg) {
    var el = document.getElementById("output");
    el.textContent = msg;
    el.scrollTop = el.scrollHeight;
}

// PTZ - hold to keep moving, quick click moves for C.ptzDur minimum
var _ptzTimer = null;
var _ptzCmd = null;
var _ptzStart = 0;

function ptzDown(cmd) {
    // Auto-stop patrol on manual PTZ movement
    var btn = document.getElementById("btnPatrol");
    if (btn && btn.classList.contains("danger")) {
        fetch("/api/patrol?action=stop").then(function(r) { return r.json(); }).then(function(d) {
            updatePatrolUI(d);
            log("Patrol auto-stopped (manual PTZ)");
        });
    }
    if (_ptzTimer) { clearTimeout(_ptzTimer); _ptzTimer = null; }
    _ptzCmd = cmd;
    _ptzStart = Date.now();
    send(cmd);
}

function ptzUp() {
    if (!_ptzCmd) return;
    var elapsed = Date.now() - _ptzStart;
    var remaining = C.ptzDur - elapsed;
    _ptzCmd = null;
    if (remaining > 0) {
        // Quick click: ensure minimum movement duration
        _ptzTimer = setTimeout(function() { send("ptzStopRun"); _ptzTimer = null; }, remaining);
    } else {
        // Held long enough: stop immediately
        send("ptzStopRun");
    }
}

function gotoPreset(name) {
    // Auto-stop patrol on manual preset go
    var btn = document.getElementById("btnPatrol");
    if (btn && btn.classList.contains("danger")) {
        fetch("/api/patrol?action=stop").then(function(r) { return r.json(); }).then(function(d) {
            updatePatrolUI(d);
            log("Patrol auto-stopped (manual preset)");
        });
    }
    send('ptzGotoPresetPoint', 'name=' + name);
}

function ptzHome() {
    send("ptzReset", null, function() {
        setTimeout(function() {
            send("getImageSetting", null, function(r) {
                if (r.brightness) log("Home position reached. Brightness: " + r.brightness + " (auto-exposure adjusting to scene)");
            });
        }, 2000);
    });
}

// Stream viewer with proper state tracking
var _streamTimer = null;
var _streaming = false;

function _connectMjpeg() {
    if (!_streaming) return;
    var img = document.getElementById("camImage");
    var s = document.getElementById("statusText");
    s.textContent = "CONNECTING..."; s.className = "stopped";
    img.onload = function() {
        if (_streaming) { s.textContent = "LIVE"; s.className = "live"; }
    };
    img.onerror = function() {
        if (!_streaming) return;
        log("Stream lost - reconnecting...");
        s.textContent = "RECONNECTING..."; s.className = "stopped";
        img.onload = null; img.onerror = null;
        img.src = "/api/snap?t=" + Date.now();
        _streamTimer = setTimeout(_connectMjpeg, 3000);
    };
    img.src = "/api/mjpeg?t=" + Date.now();
}

function startView() {
    // Clean up first (safe to call while already streaming = restart)
    if (_streamTimer) { clearTimeout(_streamTimer); _streamTimer = null; }
    var img = document.getElementById("camImage");
    img.onerror = null; img.onload = null;
    _streaming = true;
    var s = document.getElementById("statusText");
    s.textContent = "CONNECTING..."; s.className = "stopped";
    img.src = "/api/snap?t=" + Date.now();
    send("snapPicture2");
    _streamTimer = setTimeout(function() { _streamTimer = null; _connectMjpeg(); }, 2000);
}

function stopView() {
    _streaming = false;
    if (_streamTimer) { clearTimeout(_streamTimer); _streamTimer = null; }
    var img = document.getElementById("camImage");
    img.onerror = null; img.onload = null; img.src = "";
    var s = document.getElementById("statusText");
    s.textContent = "STOPPED"; s.className = "stopped";
}

// Sliders
function setSlider(cmd, param, el) {
    var val = el.value;
    el.nextElementSibling.textContent = val;
    send(cmd, param + "=" + val);
}

// IR - auto/manual mode with on/off toggle
var _ir = { auto: true, on: false };

function loadIR() {
    send("getInfraLedConfig", null, function(r) {
        _ir.auto = r.mode === "0";
        updateIrUI();
    });
}

function setIrMode(mode) {
    if (mode === "auto") {
        send("setInfraLedConfig", "mode=0", function() {
            _ir.auto = true;
            updateIrUI();
        });
    } else {
        send("setInfraLedConfig", "mode=1", function() {
            _ir.auto = false;
            updateIrUI();
        });
    }
}

function setIrLed(on) {
    var cmd = on ? "openInfraLed" : "closeInfraLed";
    send(cmd, null, function() {
        _ir.on = on;
        updateIrUI();
    });
}

function updateIrUI() {
    var btnA = document.getElementById("btnIrAuto");
    var btnM = document.getElementById("btnIrManual");
    var row = document.getElementById("irManualRow");
    var btnOn = document.getElementById("btnIrOn");
    var btnOff = document.getElementById("btnIrOff");
    btnA.className = "btn" + (_ir.auto ? " active" : "");
    btnM.className = "btn" + (!_ir.auto ? " active" : "");
    row.style.display = _ir.auto ? "none" : "flex";
    if (!_ir.auto) {
        btnOn.className = "btn" + (_ir.on ? " active" : "");
        btnOff.className = "btn" + (!_ir.on ? " danger" : "");
    }
}

// Video settings - stream 0 = main stream
// Camera uses indexed params: resolution0, bitRate0, frameRate0, etc.
var videoParams = { resolution: "7", frameRate: "25", bitRate: "4194304", GOP: "30", isVBR: "1" };

function loadVideoSettings() {
    send("getVideoStreamParam", null, function(r) {
        // Read main stream (index 0)
        if (r.resolution0 !== undefined) videoParams.resolution = r.resolution0;
        if (r.frameRate0 !== undefined) videoParams.frameRate = r.frameRate0;
        if (r.bitRate0 !== undefined) videoParams.bitRate = r.bitRate0;
        if (r.GOP0 !== undefined) videoParams.GOP = r.GOP0;
        if (r.isVBR0 !== undefined) videoParams.isVBR = r.isVBR0;
        var el;
        el = document.getElementById("selRes"); if (el) el.value = videoParams.resolution;
        el = document.getElementById("selFps"); if (el) el.value = videoParams.frameRate;
        el = document.getElementById("selBit"); if (el) el.value = videoParams.bitRate;
    });
}

function applyVideoParam(key, val) {
    videoParams[key] = val;
    // streamType=0 = main stream
    send("setVideoStreamParam",
        "streamType=0" +
        "&resolution=" + videoParams.resolution +
        "&bitRate=" + videoParams.bitRate +
        "&frameRate=" + videoParams.frameRate +
        "&GOP=" + videoParams.GOP +
        "&isVBR=" + videoParams.isVBR);
}

// Motion detection
function motionEnable() { send("setMotionDetectConfig", "isEnable=1"); }
function motionDisable() { send("setMotionDetectConfig", "isEnable=0"); }
function motionSensitivity(val) { send("setMotionDetectConfig", "isEnable=1&sensitivity=" + val); }

// Collapsible panels
function togglePanel(el) {
    el.closest(".panel").classList.toggle("collapsed");
}

// Audio - live mic from camera via MP3 stream
var _audioEl = null;

function _stopAudio() {
    if (_audioEl) {
        _audioEl.pause();
        _audioEl.removeAttribute("src");
        _audioEl.load();
        _audioEl = null;
    }
}

function _startAudio() {
    _audioEl = new Audio("/api/audio?t=" + Date.now());
    _audioEl.play().catch(function() {});
}

function toggleAudio() {
    var btn = document.getElementById("btnAudio");
    if (_audioEl) {
        _stopAudio();
        btn.textContent = "Enable Mic";
        btn.classList.remove("active");
    } else {
        _startAudio();
        btn.textContent = "Mic Enabled";
        btn.classList.add("active");
    }
}

// OSD overlay controls
var _osdState = { ts: false, dn: false };

function loadOSD() {
    send("getOSDSetting", null, function(r) {
        _osdState.ts = r.isEnableTimeStamp === "1";
        _osdState.dn = r.isEnableDevName === "1";
        var btnTs = document.getElementById("btnOsdTs");
        var btnDn = document.getElementById("btnOsdDn");
        if (btnTs) {
            btnTs.textContent = "Timestamp: " + (_osdState.ts ? "ON" : "OFF");
            btnTs.classList.toggle("active", _osdState.ts);
        }
        if (btnDn) {
            btnDn.textContent = "Cam Name: " + (_osdState.dn ? "ON" : "OFF");
            btnDn.classList.toggle("active", _osdState.dn);
        }
    });
}

function toggleOSD(which) {
    if (which === "ts") _osdState.ts = !_osdState.ts;
    else _osdState.dn = !_osdState.dn;
    send("setOSDSetting",
        "isEnableTimeStamp=" + (_osdState.ts ? "1" : "0") +
        "&isEnableDevName=" + (_osdState.dn ? "1" : "0"),
        function() { loadOSD(); });
}

function setDevName() {
    var name = document.getElementById("inpDevName").value.trim();
    if (!name) return;
    send("setDevName", "devName=" + encodeURIComponent(name), function() {
        log("Device name set to: " + name);
    });
}

// Mic gain (debounced)
var _micGainTimer = null;
function debounceMicGain(val) {
    if (_micGainTimer) clearTimeout(_micGainTimer);
    _micGainTimer = setTimeout(function() {
        fetch("/api/settings?mic_gain=" + val).then(function() {
            log("Mic gain set to " + val + "x");
            // Auto-restart audio if playing
            if (_audioEl) {
                _stopAudio();
                _startAudio();
            }
        });
    }, 400);
}

var _compLabels = {1:"Studio (largest)",2:"Very high quality",3:"High quality",4:"Good quality",5:"Balanced (default)",6:"Moderate compression",7:"Compact",8:"Small files",9:"Very small",10:"Max compression"};

function setRecCodec(val) {
    fetch("/api/settings?rec_codec=" + val).then(function() {
        log("Recording codec: " + val);
    });
}

function setRecGpu(val) {
    fetch("/api/settings?rec_gpu=" + val).then(function() {
        log("Recording GPU: " + val);
    });
}

function setRtspTransport(val) {
    fetch("/api/settings?rtsp_transport=" + val).then(function() {
        log("RTSP transport: " + val + " (stream restarting...)");
        // Stream will restart automatically on next MJPEG request
    });
}

var _compTimer = null;
function debounceRecComp(val) {
    var el = document.getElementById("compLabel");
    if (el) el.textContent = _compLabels[val] || "";
    if (_compTimer) clearTimeout(_compTimer);
    _compTimer = setTimeout(function() {
        fetch("/api/settings?rec_compression=" + val).then(function() {
            log("Compression level: " + val + "/10");
        });
    }, 400);
}

function loadSettings() {
    fetch("/api/settings").then(function(r) { return r.json(); }).then(function(d) {
        if (d.mic_gain !== undefined) {
            var sl = document.getElementById("slMicGain");
            if (sl) {
                sl.value = Math.round(d.mic_gain * 10);
                sl.nextElementSibling.textContent = d.mic_gain.toFixed(1);
            }
        }
        var sel = document.getElementById("selRecCodec");
        if (sel && d.rec_codecs) {
            sel.innerHTML = "";
            for (var key in d.rec_codecs) {
                var opt = document.createElement("option");
                opt.value = key;
                opt.textContent = d.rec_codecs[key].desc;
                sel.appendChild(opt);
            }
            if (d.rec_codec) sel.value = d.rec_codec;
        }
        if (d.rec_compression !== undefined) {
            var sl2 = document.getElementById("slRecComp");
            if (sl2) {
                sl2.value = d.rec_compression;
                sl2.nextElementSibling.textContent = d.rec_compression;
            }
            var lbl = document.getElementById("compLabel");
            if (lbl) lbl.textContent = _compLabels[d.rec_compression] || "";
        }
        if (d.rtsp_transport) {
            var rt = document.getElementById("selRtspTransport");
            if (rt) rt.value = d.rtsp_transport;
        }
        if (d.gpus && d.gpus.length > 1) {
            var gpuRow = document.getElementById("gpuRow");
            var gpuSel = document.getElementById("selRecGpu");
            if (gpuRow && gpuSel) {
                gpuRow.style.display = "flex";
                gpuSel.innerHTML = '<option value="auto">Auto</option>';
                for (var g = 0; g < d.gpus.length; g++) {
                    var opt = document.createElement("option");
                    opt.value = d.gpus[g].index;
                    opt.textContent = d.gpus[g].index + ": " + d.gpus[g].name;
                    gpuSel.appendChild(opt);
                }
                if (d.rec_gpu) gpuSel.value = d.rec_gpu;
            }
        }
    }).catch(function() {});
}

// Recording
var _recTimer = null;
var _recStart = 0;

function toggleRecording() {
    var btn = document.getElementById("btnRecord");
    if (btn.classList.contains("danger")) {
        fetch("/api/record?action=stop").then(function(r) { return r.json(); }).then(function(d) {
            updateRecUI(d);
            log("Recording stopped: " + d.filename);
        });
    } else {
        fetch("/api/record?action=start").then(function(r) { return r.json(); }).then(function(d) {
            updateRecUI(d);
            if (d.recording) log("Recording started: " + d.filename);
        });
    }
}

function updateRecUI(d) {
    var btn = document.getElementById("btnRecord");
    var status = document.getElementById("recStatus");
    var timeEl = document.getElementById("recTime");
    var fileEl = document.getElementById("recFile");
    if (d.recording) {
        btn.textContent = "Stop Recording";
        btn.classList.add("danger");
        btn.classList.remove("active");
        status.style.display = "block";
        fileEl.textContent = d.filename;
        _recStart = Date.now() - (d.elapsed * 1000);
        if (!_recTimer) {
            _recTimer = setInterval(function() {
                var s = Math.floor((Date.now() - _recStart) / 1000);
                var m = Math.floor(s / 60); s = s % 60;
                timeEl.textContent = (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;
            }, 1000);
        }
    } else {
        btn.textContent = "Record";
        btn.classList.remove("danger");
        status.style.display = "none";
        if (_recTimer) { clearInterval(_recTimer); _recTimer = null; }
    }
}

function checkRecordingStatus() {
    fetch("/api/record?action=status").then(function(r) { return r.json(); }).then(function(d) {
        updateRecUI(d);
    }).catch(function() {});
}

// Sync camera time from browser
function syncTime() {
    var now = new Date();
    var offset = -now.getTimezoneOffset() * 60;
    send("setSystemTime",
        "timeSource=1" +
        "&ntpServer=" +
        "&dateFormat=0" +
        "&timeFormat=1" +
        "&timeZone=" + offset +
        "&isDst=0" +
        "&dst=0" +
        "&year=" + now.getFullYear() +
        "&mon=" + (now.getMonth() + 1) +
        "&day=" + now.getDate() +
        "&hour=" + now.getHours() +
        "&minute=" + now.getMinutes() +
        "&sec=" + now.getSeconds(),
        function() {
            // Verify by reading back
            send("getSystemTime");
        });
}

function loadImageSettings() {
    send("getImageSetting", null, function(r) {
        if (r.brightness) { setVal("slBright", r.brightness); }
        if (r.contrast) { setVal("slContrast", r.contrast); }
        if (r.saturation) { setVal("slSat", r.saturation); }
        if (r.sharpness) { setVal("slSharp", r.sharpness); }
    });
}
function setVal(id, val) {
    var el = document.getElementById(id);
    if (el) { el.value = val; el.nextElementSibling.textContent = val; }
}

// Patrol
var _patrolTimer = null;

function togglePatrol() {
    var btn = document.getElementById("btnPatrol");
    var action = btn.classList.contains("danger") ? "stop" : "start";
    fetch("/api/patrol?action=" + action).then(function(r) { return r.json(); }).then(function(d) {
        updatePatrolUI(d);
        if (d.error) log("Patrol: " + d.error);
    });
}

function updatePatrolUI(d) {
    var btn = document.getElementById("btnPatrol");
    var status = document.getElementById("patrolStatus");
    if (d.running) {
        btn.textContent = "Stop Patrol";
        btn.classList.add("danger");
        status.style.display = "block";
        status.textContent = "Position: " + (d.current_pos || "...") + " | Cycle: " + d.cycle;
        if (!_patrolTimer) {
            _patrolTimer = setInterval(pollPatrolStatus, 2000);
        }
    } else {
        btn.textContent = "Start Patrol";
        btn.classList.remove("danger");
        status.style.display = "none";
        if (_patrolTimer) { clearInterval(_patrolTimer); _patrolTimer = null; }
    }
}

function pollPatrolStatus() {
    fetch("/api/patrol?action=status").then(function(r) { return r.json(); }).then(function(d) {
        updatePatrolUI(d);
    }).catch(function() {});
}

function loadPatrolConfig() {
    fetch("/api/patrol?action=config").then(function(r) { return r.json(); }).then(function(d) {
        updatePatrolUI(d);
        var cfg = d.config || {};
        var positions = cfg.positions || [];
        for (var i = 0; i < positions.length; i++) {
            var el = document.getElementById("patrolDwell" + (i + 1));
            if (el) el.value = positions[i].dwell || 0;
        }
        var rep = document.getElementById("patrolRepeat");
        if (rep) rep.checked = cfg.repeat !== false;
    }).catch(function() {});
}

function savePatrolConfig() {
    var positions = [];
    for (var i = 1; i <= 4; i++) {
        var el = document.getElementById("patrolDwell" + i);
        var dwell = el ? parseInt(el.value) || 0 : 0;
        positions.push({"name": "pos" + i, "dwell": dwell});
    }
    var repeat = document.getElementById("patrolRepeat").checked;
    fetch("/api/patrol?action=config&positions=" + encodeURIComponent(JSON.stringify(positions)) + "&repeat=" + repeat)
        .then(function(r) { return r.json(); })
        .then(function(d) { log("Patrol config saved"); });
}

function init() {
    // Bind PTZ hold-to-move events (mouse + touch)
    document.querySelectorAll('[data-ptz]').forEach(function(btn) {
        var cmd = btn.getAttribute('data-ptz');
        btn.addEventListener('mousedown', function(e) { e.preventDefault(); ptzDown(cmd); });
        btn.addEventListener('mouseup', function() { ptzUp(); });
        btn.addEventListener('mouseleave', function() { ptzUp(); });
        btn.addEventListener('touchstart', function(e) { e.preventDefault(); ptzDown(cmd); });
        btn.addEventListener('touchend', function(e) { e.preventDefault(); ptzUp(); });
    });

    startView();
    loadImageSettings();
    loadVideoSettings();
    loadSettings();
    loadIR();
    loadOSD();
    checkRecordingStatus();
    loadPatrolConfig();
    send("getPTZSpeed", null, function(r) {
        if (r.speed !== undefined) {
            var el = document.getElementById("selPtzSpeed");
            if (el) el.value = r.speed;
        }
    });
    send("getAudioVolume", null, function(r) {
        if (r.volume) setVal("slVolume", r.volume);
    });
}
</script>
</head>
<body onload="init()">

<div id="topbar">
    <h1>NerdCam</h1>
    <span id="statusText" class="stopped">...</span>
</div>

<div id="main">
    <div id="viewer">
        <img id="camImage" src="" alt="Camera feed" />
    </div>

    <div id="sidebar">
        <!-- PTZ -->
        <div class="panel">
            <h3 onclick="togglePanel(this)">Pan / Tilt</h3>
            <div class="panel-body">
                <div id="ptz">
                    <button data-ptz="ptzMoveTopLeft">&#8598;</button>
                    <button data-ptz="ptzMoveUp">&#8593;</button>
                    <button data-ptz="ptzMoveTopRight">&#8599;</button>
                    <button data-ptz="ptzMoveLeft">&#8592;</button>
                    <button onclick="ptzHome()" class="home" title="Return to home position. Brightness may shift as the camera adjusts auto-exposure to the new scene.">HOME</button>
                    <button data-ptz="ptzMoveRight">&#8594;</button>
                    <button data-ptz="ptzMoveBottomLeft">&#8601;</button>
                    <button data-ptz="ptzMoveDown">&#8595;</button>
                    <button data-ptz="ptzMoveBottomRight">&#8600;</button>
                </div>
                <div class="setting">
                    <label>Speed</label>
                    <select id="selPtzSpeed" onchange="send('setPTZSpeed','speed='+this.value)">
                        <option value="0">Fastest</option>
                        <option value="1">Fast</option>
                        <option value="2" selected>Normal</option>
                        <option value="3">Slow</option>
                        <option value="4">Slowest</option>
                    </select>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="gotoPreset('pos1')">Pos 1</button>
                    <button class="btn" onclick="gotoPreset('pos2')">Pos 2</button>
                    <button class="btn" onclick="gotoPreset('pos3')">Pos 3</button>
                    <button class="btn" onclick="gotoPreset('pos4')">Pos 4</button>
                </div>
                <a href="#" onclick="var s=document.getElementById('presetSaveSection');s.style.display=s.style.display==='none'?'block':'none';this.textContent=s.style.display==='none'?'Edit presets...':'Hide presets';return false" style="font-size:0.65em;color:#e94560;display:block;margin:3px 0;">Edit presets...</a>
                <div id="presetSaveSection" style="display:none">
                    <div class="btn-row">
                        <button class="btn danger" onclick="if(confirm('Overwrite Pos 1?'))send('ptzAddPresetPoint','name=pos1')">Save 1</button>
                        <button class="btn danger" onclick="if(confirm('Overwrite Pos 2?'))send('ptzAddPresetPoint','name=pos2')">Save 2</button>
                    </div>
                    <div class="btn-row">
                        <button class="btn danger" onclick="if(confirm('Overwrite Pos 3?'))send('ptzAddPresetPoint','name=pos3')">Save 3</button>
                        <button class="btn danger" onclick="if(confirm('Overwrite Pos 4?'))send('ptzAddPresetPoint','name=pos4')">Save 4</button>
                    </div>
                </div>
                <div style="border-top:1px solid #0f3460;margin-top:6px;padding-top:6px;">
                    <div style="font-size:0.68em;color:#e94560;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Patrol</div>
                    <div class="btn-row">
                        <button class="btn" id="btnPatrol" onclick="togglePatrol()">Start Patrol</button>
                    </div>
                    <div id="patrolStatus" style="font-size:0.65em;color:#7f8c8d;margin-top:2px;display:none;"></div>
                    <a href="#" onclick="var s=document.getElementById('patrolConfigSection');s.style.display=s.style.display==='none'?'block':'none';this.textContent=s.style.display==='none'?'Configure patrol...':'Hide config';return false" style="font-size:0.65em;color:#e94560;display:block;margin:3px 0;">Configure patrol...</a>
                    <div id="patrolConfigSection" style="display:none">
                        <div class="setting"><label>Pos 1 dwell</label><input type="number" id="patrolDwell1" value="0" min="0" max="300" style="width:50px"> <span style="font-size:0.65em;color:#7f8c8d">sec</span></div>
                        <div class="setting"><label>Pos 2 dwell</label><input type="number" id="patrolDwell2" value="0" min="0" max="300" style="width:50px"> <span style="font-size:0.65em;color:#7f8c8d">sec</span></div>
                        <div class="setting"><label>Pos 3 dwell</label><input type="number" id="patrolDwell3" value="0" min="0" max="300" style="width:50px"> <span style="font-size:0.65em;color:#7f8c8d">sec</span></div>
                        <div class="setting"><label>Pos 4 dwell</label><input type="number" id="patrolDwell4" value="0" min="0" max="300" style="width:50px"> <span style="font-size:0.65em;color:#7f8c8d">sec</span></div>
                        <div class="setting"><label>Repeat</label><input type="checkbox" id="patrolRepeat" checked style="width:auto"></div>
                        <button class="btn" onclick="savePatrolConfig()">Save Config</button>
                        <p style="font-size:0.55em;color:#555;margin-top:2px;">Set dwell to 0 to skip a position. Need 2+ positions with dwell &gt; 0.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- IR -->
        <div class="panel">
            <h3 onclick="togglePanel(this)">Infrared</h3>
            <div class="panel-body">
                <div class="btn-row">
                    <button class="btn" id="btnIrAuto" onclick="setIrMode('auto')">Auto</button>
                    <button class="btn" id="btnIrManual" onclick="setIrMode('manual')">Manual</button>
                </div>
                <div class="btn-row" id="irManualRow" style="display:none">
                    <button class="btn" id="btnIrOn" onclick="setIrLed(true)">ON</button>
                    <button class="btn" id="btnIrOff" onclick="setIrLed(false)">OFF</button>
                </div>
            </div>
        </div>

        <!-- Image -->
        <div class="panel">
            <h3 onclick="togglePanel(this)">Image</h3>
            <div class="panel-body">
                <div class="slider-row">
                    <label>Brightness</label>
                    <input type="range" id="slBright" min="0" max="100" value="50" oninput="setSlider('setBrightness','brightness',this)">
                    <span class="val">50</span>
                </div>
                <div class="slider-row">
                    <label>Contrast</label>
                    <input type="range" id="slContrast" min="0" max="100" value="50" oninput="setSlider('setContrast','constrast',this)">
                    <span class="val">50</span>
                </div>
                <div class="slider-row">
                    <label>Saturation</label>
                    <input type="range" id="slSat" min="0" max="100" value="50" oninput="setSlider('setSaturation','saturation',this)">
                    <span class="val">50</span>
                </div>
                <div class="slider-row">
                    <label>Sharpness</label>
                    <input type="range" id="slSharp" min="0" max="100" value="50" oninput="setSlider('setSharpness','sharpness',this)">
                    <span class="val">50</span>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="send('mirrorVideo','isMirror=1')">Mirror</button>
                    <button class="btn" onclick="send('mirrorVideo','isMirror=0')">Normal</button>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="send('flipVideo','isFlip=1')">Flip</button>
                    <button class="btn" onclick="send('flipVideo','isFlip=0')">Normal</button>
                </div>
            </div>
        </div>

        <!-- Video Settings -->
        <div class="panel collapsed">
            <h3 onclick="togglePanel(this)">Video Settings</h3>
            <div class="panel-body">
                <button class="btn" onclick="loadVideoSettings()">Reload from camera</button>
                <div class="setting">
                    <label>Resolution</label>
                    <select id="selRes" onchange="applyVideoParam('resolution',this.value)">
                        <option value="7">1080p</option>
                        <option value="0">720p</option>
                        <option value="1">VGA</option>
                        <option value="2">QVGA</option>
                    </select>
                </div>
                <div class="setting">
                    <label>Framerate</label>
                    <select id="selFps" onchange="applyVideoParam('frameRate',this.value)">
                        <option value="30">30</option>
                        <option value="25">25</option>
                        <option value="20">20</option>
                        <option value="15">15</option>
                        <option value="10">10</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="setting">
                    <label>Bitrate</label>
                    <select id="selBit" onchange="applyVideoParam('bitRate',this.value)">
                        <option value="4194304">4 Mbps</option>
                        <option value="2097152">2 Mbps</option>
                        <option value="1048576">1 Mbps</option>
                        <option value="524288">512 kbps</option>
                        <option value="262144">256 kbps</option>
                    </select>
                </div>
                <div class="setting">
                    <label>RTSP transport</label>
                    <select id="selRtspTransport" onchange="setRtspTransport(this.value)">
                        <option value="udp" selected>UDP (smooth)</option>
                        <option value="tcp">TCP (reliable)</option>
                    </select>
                </div>
                <p style="font-size:0.55em;color:#555;margin-top:1px;">UDP = low latency, may freeze during PTZ. TCP = no freezes, may be choppier.</p>
            </div>
        </div>

        <!-- Motion Detection -->
        <div class="panel collapsed">
            <h3 onclick="togglePanel(this)">Motion Detection</h3>
            <div class="panel-body">
                <p style="font-size:0.65em;color:#e67e22;margin-bottom:5px;">Not fully implemented &mdash; detection works but events are not captured by NerdCam.</p>
                <button class="btn" onclick="send('getMotionDetectConfig')">Get status</button>
                <div class="btn-row">
                    <button class="btn" onclick="motionEnable()">Enable</button>
                    <button class="btn danger" onclick="motionDisable()">Disable</button>
                </div>
                <div class="setting">
                    <label>Sensitivity</label>
                    <select onchange="motionSensitivity(this.value)">
                        <option value="2">High</option>
                        <option value="1" selected>Medium</option>
                        <option value="0">Low</option>
                        <option value="3">Lower</option>
                        <option value="4">Lowest</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Camera Speaker -->
        <div class="panel collapsed">
            <h3 onclick="togglePanel(this)">Camera Speaker</h3>
            <div class="panel-body">
                <p style="font-size:0.65em;color:#7f8c8d;margin-bottom:5px;">Controls the camera's built-in speaker volume. Sending audio to the camera requires a proprietary protocol (not yet supported).</p>
                <div class="slider-row">
                    <label>Speaker vol</label>
                    <input type="range" id="slVolume" min="0" max="100" value="100" oninput="this.nextElementSibling.textContent=this.value;send('setAudioVolume','volume='+this.value)">
                    <span class="val">100</span>
                </div>
            </div>
        </div>

        <!-- OSD Overlay -->
        <div class="panel collapsed">
            <h3 onclick="togglePanel(this)">OSD Overlay</h3>
            <div class="panel-body">
                <div class="btn-row">
                    <button class="btn" id="btnOsdTs" onclick="toggleOSD('ts')">Timestamp: ...</button>
                </div>
                <div class="btn-row">
                    <button class="btn" id="btnOsdDn" onclick="toggleOSD('dn')">Cam Name: ...</button>
                </div>
                <div class="setting">
                    <label>Device name</label>
                    <input type="text" id="inpDevName" style="width:100px" placeholder="NerdCam">
                </div>
                <button class="btn" onclick="setDevName()">Set Name</button>
            </div>
        </div>

        <!-- Audio & Recording -->
        <div class="panel">
            <h3 onclick="togglePanel(this)">Audio &amp; Recording</h3>
            <div class="panel-body">
                <div class="btn-row">
                    <button class="btn" id="btnAudio" onclick="toggleAudio()">Enable Mic</button>
                </div>
                <div class="slider-row">
                    <label>Mic gain</label>
                    <input type="range" id="slMicGain" min="10" max="50" value="30" step="1" oninput="this.nextElementSibling.textContent=(this.value/10).toFixed(1);debounceMicGain(this.value/10)">
                    <span class="val">3.0</span>
                </div>
                <div class="setting">
                    <label>Rec codec</label>
                    <select id="selRecCodec" style="width:115px" onchange="setRecCodec(this.value)">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="setting" id="gpuRow" style="display:none">
                    <label>Rec GPU</label>
                    <select id="selRecGpu" style="width:115px" onchange="setRecGpu(this.value)">
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <div class="slider-row">
                    <label>Compress</label>
                    <input type="range" id="slRecComp" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value;debounceRecComp(this.value)">
                    <span class="val">5</span>
                </div>
                <div style="font-size:0.55em;color:#555;margin:-1px 0 2px 70px;" id="compLabel">Balanced (default)</div>
                <div class="btn-row">
                    <button class="btn" id="btnRecord" onclick="toggleRecording()" style="flex:2">Record</button>
                </div>
                <div id="recStatus" style="font-size:0.65em;color:#7f8c8d;margin-top:2px;display:none;">
                    <span id="recTime">00:00</span> &mdash; <span id="recFile"></span>
                </div>
                <p style="font-size:0.6em;color:#555;margin-top:3px;">Saves to: recordings/</p>
            </div>
        </div>

        <!-- Info -->
        <div class="panel collapsed">
            <h3 onclick="togglePanel(this)">Device Info</h3>
            <div class="panel-body">
                <div class="btn-row">
                    <button class="btn" onclick="send('getDevInfo')">Device</button>
                    <button class="btn" onclick="send('getDevState')">State</button>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="send('getWifiConfig')">WiFi</button>
                    <button class="btn" onclick="send('getPortInfo')">Ports</button>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="send('getIPInfo')">IP Info</button>
                    <button class="btn" onclick="syncTime()">Sync Time</button>
                </div>
            </div>
        </div>

        <!-- Output -->
        <div class="panel">
            <h3>Output</h3>
            <div id="output">Ready.</div>
        </div>
    </div>
</div>

</body>
</html>
