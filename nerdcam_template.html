<!DOCTYPE html>
<!--
NerdCam Viewer - Foscam R2 camera control and live view.
All requests go through local proxy (same origin, no CORS).
Served by nerdcam.py proxy server.
-->
<html>
<head>
<meta charset="UTF-8">
<title>NerdCam Viewer</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: #1a1a2e;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
}
#topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: #16213e;
    border-bottom: 2px solid #0f3460;
}
#topbar h1 { font-size: 1.1em; color: #e94560; }
.live { color: #2ecc71; font-weight: bold; font-size: 0.85em; }
.stopped { color: #e74c3c; font-weight: bold; font-size: 0.85em; }
#main { display: flex; flex: 1; overflow: hidden; }
#viewer {
    flex: 1; display: flex; align-items: center;
    justify-content: center; background: #000;
}
#viewer img, #viewer video { max-width: 100%; max-height: 100%; object-fit: contain; }
#sidebar {
    width: 280px; background: #16213e; padding: 12px;
    display: flex; flex-direction: column; gap: 8px;
    border-left: 2px solid #0f3460; overflow-y: auto;
}
.panel h3 {
    font-size: 0.78em; color: #e94560; margin-bottom: 5px;
    text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
    user-select: none;
}
.panel h3:hover { color: #fff; }
.panel h3::before { content: "\25BE "; margin-right: 4px; }
.panel.collapsed .panel-body { display: none; }
.panel.collapsed h3::before { content: "\25B8 "; }
#ptz {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 3px; max-width: 180px;
}
#ptz button {
    width: 100%; aspect-ratio: 1; border: 1px solid #0f3460;
    background: #1a1a2e; color: #eee; font-size: 1.3em;
    cursor: pointer; border-radius: 4px;
}
#ptz button:hover { background: #e94560; }
#ptz button:active { background: #c0392b; }
#ptz button.home { background: #0f3460; font-size: 0.6em; }
.btn {
    padding: 4px 8px; border: 1px solid #0f3460; background: #0f3460;
    color: #eee; border-radius: 4px; cursor: pointer;
    font-size: 0.75em; width: 100%; margin-top: 2px;
}
.btn:hover { background: #e94560; border-color: #e94560; }
.btn.danger { background: #c0392b; border-color: #c0392b; }
.btn.active { background: #2ecc71; border-color: #2ecc71; }
.btn-row { display: flex; gap: 3px; }
.btn-row .btn { flex: 1; }
.slider-row {
    display: flex; align-items: center; gap: 5px; margin: 3px 0;
}
.slider-row label { font-size: 0.68em; color: #7f8c8d; width: 65px; }
.slider-row input[type=range] { flex: 1; accent-color: #e94560; }
.slider-row .val { font-size: 0.68em; width: 25px; text-align: right; }
.setting { display: flex; align-items: center; gap: 5px; margin: 3px 0; }
.setting label { font-size: 0.68em; color: #7f8c8d; width: 85px; }
.setting input, .setting select {
    background: #1a1a2e; border: 1px solid #0f3460; color: #eee;
    padding: 2px 5px; border-radius: 3px; font-size: 0.75em; width: 75px;
}
#output {
    font-family: monospace; font-size: 0.62em; background: #0d0d1a;
    border: 1px solid #0f3460; border-radius: 4px; padding: 6px;
    height: 130px; overflow-y: auto; white-space: pre-wrap;
    word-break: break-all; color: #7f8c8d;
}
.patrol-time-row {
    display: flex; align-items: center; gap: 4px; margin: 3px 0;
}
.patrol-time-label {
    font-size: 0.68em; color: #7f8c8d; width: 22px; flex-shrink: 0;
}
.patrol-time-inputs {
    display: flex; align-items: center; gap: 2px; flex: 1; min-width: 0;
}
.patrol-time-inputs select {
    flex: 1; min-width: 0; width: 0;
    background: #1a1a2e; border: 1px solid #0f3460; color: #eee;
    padding: 4px 1px; border-radius: 3px; font-size: 0.75em;
    text-align: center; -webkit-appearance: none; appearance: none;
}
.patrol-time-inputs span {
    font-size: 0.6em; color: #7f8c8d; flex-shrink: 0;
}
.patrol-dot {
    display: inline-flex; align-items: center; justify-content: center;
    width: 18px; height: 18px; border-radius: 3px; font-size: 0.7em;
    background: #1a1a2e; color: #555; border: 1px solid #0f3460;
    transition: all 0.3s;
}
.patrol-dot.active {
    background: #e94560; color: #fff; border-color: #e94560;
}
.patrol-dot.skipped {
    opacity: 0.3;
}
</style>
<script>
var C = { ptzDur: 500 };
var viewerTask = null;

// All requests go through local proxy -- no CORS issues
function send(cmd, extra, callback) {
    var url = "/api/cam?cmd=" + cmd;
    if (extra) url += "&" + extra;
    fetch(url).then(function(r) { return r.text(); }).then(function(text) {
        // Parse XML response
        var parser = new DOMParser();
        var xml = parser.parseFromString(text, "text/xml");
        var result = {};
        var nodes = xml.documentElement.children;
        var lines = [];
        for (var i = 0; i < nodes.length; i++) {
            var key = nodes[i].tagName;
            var val = nodes[i].textContent || "";
            result[key] = val;
            if (key !== "result") lines.push(key + ": " + decodeURIComponent(val));
        }
        log(cmd + " (result=" + (result.result||"?") + "):\n" + lines.join("\n"));
        if (callback) callback(result);
    }).catch(function(e) {
        log(cmd + ": ERROR " + e);
    });
}

function log(msg) {
    var el = document.getElementById("output");
    el.textContent = msg;
    el.scrollTop = el.scrollHeight;
}

// PTZ - hold to keep moving, quick click moves for C.ptzDur minimum
var _ptzTimer = null;
var _ptzCmd = null;
var _ptzStart = 0;

function ptzDown(cmd) {
    // Auto-stop patrol on manual PTZ movement
    var btn = document.getElementById("btnPatrol");
    if (btn && btn.classList.contains("danger")) {
        fetch("/api/patrol?action=stop").then(function(r) { return r.json(); }).then(function(d) {
            updatePatrolUI(d);
            log("Patrol auto-stopped (manual PTZ)");
        });
    }
    if (_ptzTimer) { clearTimeout(_ptzTimer); _ptzTimer = null; }
    _ptzCmd = cmd;
    _ptzStart = Date.now();
    send(cmd);
}

function ptzUp() {
    if (!_ptzCmd) return;
    var elapsed = Date.now() - _ptzStart;
    var remaining = C.ptzDur - elapsed;
    _ptzCmd = null;
    if (remaining > 0) {
        // Quick click: ensure minimum movement duration
        _ptzTimer = setTimeout(function() { send("ptzStopRun"); _ptzTimer = null; }, remaining);
    } else {
        // Held long enough: stop immediately
        send("ptzStopRun");
    }
}

function savePreset(name) {
    // Foscam firmware ignores ptzAddPresetPoint if name already exists,
    // so delete first then re-add to actually update the position.
    // Delay needed: camera firmware needs time to finalize the delete.
    send('ptzDeletePresetPoint', 'name=' + name, function() {
        setTimeout(function() {
            send('ptzAddPresetPoint', 'name=' + name);
        }, 1000);
    });
}

function gotoPreset(name) {
    // Auto-stop patrol on manual preset go
    var btn = document.getElementById("btnPatrol");
    if (btn && btn.classList.contains("danger")) {
        fetch("/api/patrol?action=stop").then(function(r) { return r.json(); }).then(function(d) {
            updatePatrolUI(d);
            log("Patrol auto-stopped (manual preset)");
        });
    }
    send('ptzGotoPresetPoint', 'name=' + name);
}

function ptzHome() {
    send("ptzReset", null, function() {
        setTimeout(function() {
            send("getImageSetting", null, function(r) {
                if (r.brightness) log("Home position reached. Brightness: " + r.brightness + " (auto-exposure adjusting to scene)");
            });
        }, 2000);
    });
}

// Stream viewer with proper state tracking
var _streamTimer = null;
var _streaming = false;

// Shared server health check — used by both MJPEG and MSE reconnect logic
function _checkServer(callback) {
    fetch("/api/settings?t=" + Date.now())
        .then(function(resp) { callback(resp.ok); })
        .catch(function() { callback(false); });
}

// --- MSE (MediaSource Extensions) engine ---
var _mseActive = false;
var _mseSource = null;
var _mseBuffer = null;
var _mseReader = null;
var _mseQueue = [];
var _mseReconnTimer = null;
var _mseAbortCtrl = null;
var _mseLagTimer = null;
var _mseHealthTimer = null;
var _lastMseDataTime = 0;

// Codec strings to try (camera sends H.264 High profile 1080p + AAC)
var _mseCodecs = [
    'video/mp4; codecs="avc1.640028, mp4a.40.2"',  // High L4.0 + AAC-LC
    'video/mp4; codecs="avc1.4D4028, mp4a.40.2"',  // Main L4.0 + AAC-LC
    'video/mp4; codecs="avc1.42E028, mp4a.40.2"',  // Baseline L4.0 + AAC-LC
    'video/mp4; codecs="avc1.640028"',               // High L4.0 video only
    'video/mp4; codecs="avc1.4D4028"'                // Main L4.0 video only
];

function _mseSupported() {
    if (typeof MediaSource === "undefined") return false;
    for (var i = 0; i < _mseCodecs.length; i++) {
        if (MediaSource.isTypeSupported(_mseCodecs[i])) return true;
    }
    return false;
}

function _mseFindCodec() {
    for (var i = 0; i < _mseCodecs.length; i++) {
        if (MediaSource.isTypeSupported(_mseCodecs[i])) return _mseCodecs[i];
    }
    return null;
}

function _mseStart() {
    var video = document.getElementById("camVideo");
    var img = document.getElementById("camImage");
    var s = document.getElementById("statusText");

    _mseSource = new MediaSource();
    video.src = URL.createObjectURL(_mseSource);
    video.style.display = "";
    img.style.display = "none";
    _mseActive = true;

    _mseSource.addEventListener("sourceopen", function() {
        var codec = _mseFindCodec();
        if (!codec) { _mseFallback("No supported codec"); return; }
        try {
            _mseBuffer = _mseSource.addSourceBuffer(codec);
        } catch (e) {
            _mseFallback("SourceBuffer error: " + e.message);
            return;
        }
        _mseBuffer.mode = "segments";
        _mseBuffer.addEventListener("updateend", _mseProcessQueue);
        _mseBuffer.addEventListener("error", function() {
            log("MSE buffer error");
            _mseReconnect();
        });
        log("MSE started (" + codec.split('"')[1] + ")");
        if (_mseLagTimer) clearInterval(_mseLagTimer);
        _mseLagTimer = setInterval(_mseChaseLive, 3000);
        _mseFetch();
    });
}

function _mseStartHealthCheck() {
    if (_mseHealthTimer) clearInterval(_mseHealthTimer);
    _lastMseDataTime = Date.now();
    _mseHealthTimer = setInterval(function() {
        if (!_mseActive) { clearInterval(_mseHealthTimer); _mseHealthTimer = null; return; }
        var age = Date.now() - _lastMseDataTime;
        if (age > 5000) {
            clearInterval(_mseHealthTimer); _mseHealthTimer = null;
            log("MSE stale (" + (age/1000).toFixed(0) + "s)");
            if (_mseAbortCtrl) { try { _mseAbortCtrl.abort(); } catch(e){} }
            _mseReconnect();
        }
    }, 2000);
}

function _mseFetch() {
    var s = document.getElementById("statusText");
    s.textContent = "CONNECTING..."; s.className = "stopped";

    _mseAbortCtrl = new AbortController();
    fetch("/api/fmp4?t=" + Date.now(), { signal: _mseAbortCtrl.signal })
        .then(function(resp) {
            if (!resp.ok || !resp.body) { _mseReconnect(); return; }
            s.textContent = "LIVE"; s.className = "live";
            _mseReader = resp.body.getReader();
            _mseReadChunk();
            _mseStartHealthCheck();
        })
        .catch(function(e) {
            if (e.name !== "AbortError") {
                log("MSE fetch error: " + e.message);
                _mseReconnect();
            }
        });
}

function _mseReadChunk() {
    if (!_mseReader || !_mseActive) return;
    _mseReader.read().then(function(result) {
        if (result.done) {
            log("MSE stream ended");
            _mseReconnect();
            return;
        }
        _lastMseDataTime = Date.now();
        _mseQueue.push(result.value);
        _mseProcessQueue();
        _mseReadChunk();
    }).catch(function(e) {
        if (e.name !== "AbortError" && _mseActive) {
            log("MSE read error: " + e.message);
            _mseReconnect();
        }
    });
}

function _mseProcessQueue() {
    if (!_mseBuffer || _mseBuffer.updating || _mseQueue.length === 0) return;
    if (_mseSource.readyState !== "open") return;
    var chunk = _mseQueue.shift();
    try {
        _mseBuffer.appendBuffer(chunk);
    } catch (e) {
        log("MSE append error: " + e.message);
        _mseQueue = [];
        _mseReconnect();
        return;
    }
    // Trim buffer: keep last 10 seconds
    try {
        var video = document.getElementById("camVideo");
        if (_mseBuffer.buffered.length > 0 && video.currentTime > 12) {
            _mseBuffer.remove(0, video.currentTime - 10);
        }
    } catch (e) { /* ignore trim errors */ }
}

function _mseChaseLive() {
    if (!_mseActive || !_mseBuffer) return;
    var video = document.getElementById("camVideo");
    if (_mseBuffer.buffered.length === 0) return;
    var end = _mseBuffer.buffered.end(_mseBuffer.buffered.length - 1);
    var lag = end - video.currentTime;
    if (lag > 3) {
        // Too far behind: jump to near live edge
        video.currentTime = end - 0.5;
        log("MSE: jumped to live (" + lag.toFixed(1) + "s behind)");
    } else if (lag > 1.5) {
        // Slightly behind: speed up playback to catch up
        video.playbackRate = 1.05;
    } else {
        video.playbackRate = 1.0;
    }
}

function _mseReconnect() {
    if (_mseReconnTimer) return; // already scheduled
    if (!_mseActive) return;
    var s = document.getElementById("statusText");
    s.textContent = "RECONNECTING..."; s.className = "stopped";
    log("MSE reconnecting...");

    // Stop current stream but preserve _mseActive and _mseReconnTimer
    _mseCleanup();

    _mseReconnTimer = setTimeout(function _retry() {
        _mseReconnTimer = null;
        if (!_mseActive) return;
        _checkServer(function(alive) {
            if (!_mseActive) return;
            if (alive) {
                log("MSE server back, restarting");
                _mseStart();
                setTimeout(function() {
                    document.getElementById("camVideo").muted = false;
                }, 500);
            } else {
                document.getElementById("camVideo").style.display = "none";
                s.textContent = "DISCONNECTED"; s.className = "stopped";
                _mseReconnTimer = setTimeout(_retry, 3000);
            }
        });
    }, 2000);
}

function _mseCleanup() {
    // Clean up stream resources. Does NOT touch _mseActive or _mseReconnTimer.
    if (_mseLagTimer) { clearInterval(_mseLagTimer); _mseLagTimer = null; }
    if (_mseHealthTimer) { clearInterval(_mseHealthTimer); _mseHealthTimer = null; }
    if (_mseAbortCtrl) { try { _mseAbortCtrl.abort(); } catch(e){} _mseAbortCtrl = null; }
    _mseReader = null;
    _mseQueue = [];
    if (_mseBuffer && _mseSource && _mseSource.readyState === "open") {
        try { _mseSource.removeSourceBuffer(_mseBuffer); } catch(e){}
    }
    _mseBuffer = null;
    if (_mseSource && _mseSource.readyState === "open") {
        try { _mseSource.endOfStream(); } catch(e){}
    }
    _mseSource = null;
    var video = document.getElementById("camVideo");
    if (video.src) { URL.revokeObjectURL(video.src); video.removeAttribute("src"); }
}

function _mseStop() {
    _mseActive = false;
    if (_mseReconnTimer) { clearTimeout(_mseReconnTimer); _mseReconnTimer = null; }
    _mseCleanup();
    var video = document.getElementById("camVideo");
    video.style.display = "none";
}

function _mseFallback(reason) {
    log("MSE fallback: " + reason);
    _mseStop();
    // Switch to MJPEG path
    var img = document.getElementById("camImage");
    img.style.display = "";
    _connectMjpeg();
}

// --- MJPEG ---
var _mjpegWatchdog = null;

function _connectMjpeg() {
    if (!_streaming) return;
    var img = document.getElementById("camImage");
    var s = document.getElementById("statusText");
    s.textContent = "CONNECTING..."; s.className = "stopped";
    img.onload = function() {
        if (_streaming) { s.textContent = "LIVE"; s.className = "live"; }
    };
    img.src = "/api/mjpeg?t=" + Date.now();

    // Watchdog: periodically check if server is still alive.
    // Independent of onerror/onload — works the same in all browsers.
    if (_mjpegWatchdog) clearInterval(_mjpegWatchdog);
    _mjpegWatchdog = setInterval(function() {
        if (!_streaming || _mseActive) {
            clearInterval(_mjpegWatchdog); _mjpegWatchdog = null;
            return;
        }
        _checkServer(function(alive) {
            if (!_streaming || _mseActive) return;
            if (!alive) {
                // Server down — show disconnected, keep watchdog running to detect comeback
                log("Server unreachable");
                img.onload = null;
                img.removeAttribute("src");
                s.textContent = "DISCONNECTED"; s.className = "stopped";
            } else if (s.className !== "live") {
                // Server up but stream not live — reconnect
                log("Server alive, reconnecting MJPEG");
                img.onload = function() {
                    if (_streaming) { s.textContent = "LIVE"; s.className = "live"; }
                };
                img.src = "/api/mjpeg?t=" + Date.now();
            }
        });
    }, 8000);
}

function startView() {
    // Clean up first
    if (_streamTimer) { clearTimeout(_streamTimer); _streamTimer = null; }
    _mseStop();
    var img = document.getElementById("camImage");
    img.onerror = null; img.onload = null;
    _streaming = true;
    var s = document.getElementById("statusText");
    s.textContent = "CONNECTING..."; s.className = "stopped";

    // Always start with MJPEG (fast ~1s video)
    // MSE only activates when user enables mic (toggleAudio)
    img.style.display = "";
    img.src = "/api/snap?t=" + Date.now();
    send("snapPicture2");
    _streamTimer = setTimeout(function() { _streamTimer = null; _connectMjpeg(); }, 2000);
}

function stopView() {
    _streaming = false;
    if (_streamTimer) { clearTimeout(_streamTimer); _streamTimer = null; }
    if (_mjpegWatchdog) { clearInterval(_mjpegWatchdog); _mjpegWatchdog = null; }
    _mseStop();
    _stopAudio();
    var img = document.getElementById("camImage");
    img.onerror = null; img.onload = null; img.removeAttribute("src");
    img.style.display = "";
    var s = document.getElementById("statusText");
    s.textContent = "STOPPED"; s.className = "stopped";
}

// Sliders
function setSlider(cmd, param, el) {
    var val = el.value;
    el.nextElementSibling.textContent = val;
    send(cmd, param + "=" + val);
}

// IR - auto/manual mode with on/off toggle
var _ir = { auto: true, on: false };

function loadIR() {
    send("getInfraLedConfig", null, function(r) {
        _ir.auto = r.mode === "0";
        updateIrUI();
    });
}

function setIrMode(mode) {
    if (mode === "auto") {
        send("setInfraLedConfig", "mode=0", function() {
            _ir.auto = true;
            updateIrUI();
        });
    } else {
        send("setInfraLedConfig", "mode=1", function() {
            _ir.auto = false;
            updateIrUI();
        });
    }
}

function setIrLed(on) {
    var cmd = on ? "openInfraLed" : "closeInfraLed";
    send(cmd, null, function() {
        _ir.on = on;
        updateIrUI();
    });
}

function updateIrUI() {
    var btnA = document.getElementById("btnIrAuto");
    var btnM = document.getElementById("btnIrManual");
    var row = document.getElementById("irManualRow");
    var btnOn = document.getElementById("btnIrOn");
    var btnOff = document.getElementById("btnIrOff");
    btnA.className = "btn" + (_ir.auto ? " active" : "");
    btnM.className = "btn" + (!_ir.auto ? " active" : "");
    row.style.display = _ir.auto ? "none" : "flex";
    if (!_ir.auto) {
        btnOn.className = "btn" + (_ir.on ? " active" : "");
        btnOff.className = "btn" + (!_ir.on ? " danger" : "");
    }
}

// Video settings - stream 0 = main stream
// Camera uses indexed params: resolution0, bitRate0, frameRate0, etc.
var videoParams = { resolution: "7", frameRate: "25", bitRate: "4194304", GOP: "30", isVBR: "1" };

function loadVideoSettings() {
    send("getVideoStreamParam", null, function(r) {
        // Read main stream (index 0)
        if (r.resolution0 !== undefined) videoParams.resolution = r.resolution0;
        if (r.frameRate0 !== undefined) videoParams.frameRate = r.frameRate0;
        if (r.bitRate0 !== undefined) videoParams.bitRate = r.bitRate0;
        if (r.GOP0 !== undefined) videoParams.GOP = r.GOP0;
        if (r.isVBR0 !== undefined) videoParams.isVBR = r.isVBR0;
        var el;
        el = document.getElementById("selRes"); if (el) el.value = videoParams.resolution;
        el = document.getElementById("selFps"); if (el) el.value = videoParams.frameRate;
        el = document.getElementById("selBit"); if (el) el.value = videoParams.bitRate;
    });
}

function applyVideoParam(key, val) {
    videoParams[key] = val;
    // streamType=0 = main stream
    send("setVideoStreamParam",
        "streamType=0" +
        "&resolution=" + videoParams.resolution +
        "&bitRate=" + videoParams.bitRate +
        "&frameRate=" + videoParams.frameRate +
        "&GOP=" + videoParams.GOP +
        "&isVBR=" + videoParams.isVBR);
}

// Motion detection
function motionEnable() { send("setMotionDetectConfig", "isEnable=1"); }
function motionDisable() { send("setMotionDetectConfig", "isEnable=0"); }
function motionSensitivity(val) { send("setMotionDetectConfig", "isEnable=1&sensitivity=" + val); }

// Collapsible panels
function togglePanel(el) {
    el.closest(".panel").classList.toggle("collapsed");
}

// Audio - live mic from camera via MP3 stream
var _audioEl = null;

function _stopAudio() {
    if (_audioEl) {
        _audioEl.pause();
        _audioEl.removeAttribute("src");
        _audioEl.load();
        _audioEl = null;
    }
}

function _startAudio() {
    _audioEl = new Audio("/api/audio?t=" + Date.now());
    _audioEl.play().catch(function() {});
}

function toggleAudio() {
    var btn = document.getElementById("btnAudio");
    if (_mseActive) {
        // Currently on MSE (synced A/V) -> switch back to MJPEG (fast video, no audio)
        _mseStop();
        btn.textContent = "Enable Mic";
        btn.classList.remove("active");
        // Restart MJPEG stream
        var img = document.getElementById("camImage");
        img.style.display = "";
        _connectMjpeg();
        log("Mic off - switched to fast video");
    } else {
        // Currently on MJPEG -> switch to MSE (synced A/V with audio)
        if (!_mseSupported()) {
            // MSE not available, fall back to separate audio element
            if (_audioEl) {
                _stopAudio();
                btn.textContent = "Enable Mic";
                btn.classList.remove("active");
            } else {
                _startAudio();
                btn.textContent = "Mic Enabled";
                btn.classList.add("active");
                log("Mic on (no sync - MSE not supported)");
            }
            return;
        }
        // Stop MJPEG, start MSE with audio unmuted
        if (_streamTimer) { clearTimeout(_streamTimer); _streamTimer = null; }
        var img = document.getElementById("camImage");
        img.onerror = null; img.onload = null; img.removeAttribute("src");
        _mseStart();
        // Unmute after a short delay (let MSE initialize)
        setTimeout(function() {
            var video = document.getElementById("camVideo");
            video.muted = false;
        }, 500);
        btn.textContent = "Mic Enabled";
        btn.classList.add("active");
        log("Mic on - switched to synced A/V stream");
    }
}

// OSD overlay controls
var _osdState = { ts: false, dn: false };

function loadOSD() {
    send("getOSDSetting", null, function(r) {
        _osdState.ts = r.isEnableTimeStamp === "1";
        _osdState.dn = r.isEnableDevName === "1";
        var btnTs = document.getElementById("btnOsdTs");
        var btnDn = document.getElementById("btnOsdDn");
        if (btnTs) {
            btnTs.textContent = "Timestamp: " + (_osdState.ts ? "ON" : "OFF");
            btnTs.classList.toggle("active", _osdState.ts);
        }
        if (btnDn) {
            btnDn.textContent = "Cam Name: " + (_osdState.dn ? "ON" : "OFF");
            btnDn.classList.toggle("active", _osdState.dn);
        }
    });
}

function toggleOSD(which) {
    if (which === "ts") _osdState.ts = !_osdState.ts;
    else _osdState.dn = !_osdState.dn;
    send("setOSDSetting",
        "isEnableTimeStamp=" + (_osdState.ts ? "1" : "0") +
        "&isEnableDevName=" + (_osdState.dn ? "1" : "0"),
        function() { loadOSD(); });
}

function setDevName() {
    var name = document.getElementById("inpDevName").value.trim();
    if (!name) return;
    send("setDevName", "devName=" + encodeURIComponent(name), function() {
        log("Device name set to: " + name);
    });
}

// Mic gain - slider updates display only, Apply button saves and restarts
function updateMicGainDisplay(val) {
    document.getElementById("micGainVal").textContent = (val / 10).toFixed(1);
}

function applyMicGain() {
    var sl = document.getElementById("slMicGain");
    var val = (sl.value / 10).toFixed(1);
    fetch("/api/settings?mic_gain=" + val).then(function() {
        log("Mic gain applied: " + val + "x");
        if (_mseActive) {
            // Stop MJPEG watchdog to prevent it from reconnecting during MSE restart
            if (_mjpegWatchdog) { clearInterval(_mjpegWatchdog); _mjpegWatchdog = null; }
            // Cleanly switch: stop MSE, then restart with new gain
            _mseStop();
            var img = document.getElementById("camImage");
            img.style.display = "none";
            _mseStart();
            setTimeout(function() {
                document.getElementById("camVideo").muted = false;
            }, 500);
        } else if (_audioEl) {
            _stopAudio();
            _startAudio();
        }
    });
}

var _compLabels = {1:"Studio (largest)",2:"Very high quality",3:"High quality",4:"Good quality",5:"Balanced (default)",6:"Moderate compression",7:"Compact",8:"Small files",9:"Very small",10:"Max compression"};

function setRecCodec(val) {
    fetch("/api/settings?rec_codec=" + val).then(function() {
        log("Recording codec: " + val);
    });
}

function setRecGpu(val) {
    fetch("/api/settings?rec_gpu=" + val).then(function() {
        log("Recording GPU: " + val);
    });
}

function setRtspTransport(val) {
    fetch("/api/settings?rtsp_transport=" + val).then(function() {
        log("RTSP transport: " + val + " (stream restarting...)");
        // Stream will restart automatically on next MJPEG request
    });
}

var _compTimer = null;
function debounceRecComp(val) {
    var el = document.getElementById("compLabel");
    if (el) el.textContent = _compLabels[val] || "";
    if (_compTimer) clearTimeout(_compTimer);
    _compTimer = setTimeout(function() {
        fetch("/api/settings?rec_compression=" + val).then(function() {
            log("Compression level: " + val + "/10");
        });
    }, 400);
}

function loadSettings() {
    fetch("/api/settings").then(function(r) { return r.json(); }).then(function(d) {
        if (d.mic_gain !== undefined) {
            var sl = document.getElementById("slMicGain");
            if (sl) {
                sl.value = Math.round(d.mic_gain * 10);
                document.getElementById("micGainVal").textContent = d.mic_gain.toFixed(1);
            }
        }
        var sel = document.getElementById("selRecCodec");
        if (sel && d.rec_codecs) {
            sel.innerHTML = "";
            for (var key in d.rec_codecs) {
                var opt = document.createElement("option");
                opt.value = key;
                opt.textContent = d.rec_codecs[key].desc;
                sel.appendChild(opt);
            }
            if (d.rec_codec) sel.value = d.rec_codec;
        }
        if (d.rec_compression !== undefined) {
            var sl2 = document.getElementById("slRecComp");
            if (sl2) {
                sl2.value = d.rec_compression;
                sl2.nextElementSibling.textContent = d.rec_compression;
            }
            var lbl = document.getElementById("compLabel");
            if (lbl) lbl.textContent = _compLabels[d.rec_compression] || "";
        }
        if (d.rtsp_transport) {
            var rt = document.getElementById("selRtspTransport");
            if (rt) rt.value = d.rtsp_transport;
        }
        if (d.gpus && d.gpus.length > 1) {
            var gpuRow = document.getElementById("gpuRow");
            var gpuSel = document.getElementById("selRecGpu");
            if (gpuRow && gpuSel) {
                gpuRow.style.display = "flex";
                gpuSel.innerHTML = '<option value="auto">Auto</option>';
                for (var g = 0; g < d.gpus.length; g++) {
                    var opt = document.createElement("option");
                    opt.value = d.gpus[g].index;
                    opt.textContent = d.gpus[g].index + ": " + d.gpus[g].name;
                    gpuSel.appendChild(opt);
                }
                if (d.rec_gpu) gpuSel.value = d.rec_gpu;
            }
        }
    }).catch(function() {});
}

// Recording
var _recTimer = null;
var _recStart = 0;

function toggleRecording() {
    var btn = document.getElementById("btnRecord");
    if (btn.classList.contains("danger")) {
        fetch("/api/record?action=stop").then(function(r) { return r.json(); }).then(function(d) {
            updateRecUI(d);
            log("Recording stopped: " + d.filename);
        });
    } else {
        fetch("/api/record?action=start").then(function(r) { return r.json(); }).then(function(d) {
            updateRecUI(d);
            if (d.recording) log("Recording started: " + d.filename);
        });
    }
}

function updateRecUI(d) {
    var btn = document.getElementById("btnRecord");
    var status = document.getElementById("recStatus");
    var timeEl = document.getElementById("recTime");
    var fileEl = document.getElementById("recFile");
    if (d.recording) {
        btn.textContent = "Stop Recording";
        btn.classList.add("danger");
        btn.classList.remove("active");
        status.style.display = "block";
        fileEl.textContent = d.filename;
        _recStart = Date.now() - (d.elapsed * 1000);
        if (!_recTimer) {
            _recTimer = setInterval(function() {
                var s = Math.floor((Date.now() - _recStart) / 1000);
                var m = Math.floor(s / 60); s = s % 60;
                timeEl.textContent = (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;
            }, 1000);
        }
    } else {
        btn.textContent = "Record";
        btn.classList.remove("danger");
        status.style.display = "none";
        if (_recTimer) { clearInterval(_recTimer); _recTimer = null; }
    }
}

function checkRecordingStatus() {
    fetch("/api/record?action=status").then(function(r) { return r.json(); }).then(function(d) {
        updateRecUI(d);
    }).catch(function() {});
}

// Sync camera time from browser
function syncTime() {
    // Foscam R2 subtracts timeZone from the provided time, so always send
    // timeZone=0 with local time to avoid double-offset. See camera_control.py.
    var now = new Date();
    send("setSystemTime",
        "timeSource=1" +
        "&ntpServer=" +
        "&dateFormat=0" +
        "&timeFormat=1" +
        "&timeZone=0" +
        "&isDst=0" +
        "&dst=0" +
        "&year=" + now.getFullYear() +
        "&mon=" + (now.getMonth() + 1) +
        "&day=" + now.getDate() +
        "&hour=" + now.getHours() +
        "&minute=" + now.getMinutes() +
        "&sec=" + now.getSeconds(),
        function() {
            // Verify by reading back
            send("getSystemTime");
        });
}

function loadImageSettings() {
    send("getImageSetting", null, function(r) {
        if (r.brightness) { setVal("slBright", r.brightness); }
        if (r.contrast) { setVal("slContrast", r.contrast); }
        if (r.saturation) { setVal("slSat", r.saturation); }
        if (r.sharpness) { setVal("slSharp", r.sharpness); }
    });
}
function setVal(id, val) {
    var el = document.getElementById(id);
    if (el) { el.value = val; el.nextElementSibling.textContent = val; }
}

// Patrol
var _patrolTimer = null;

function togglePatrol() {
    var btn = document.getElementById("btnPatrol");
    var action = btn.classList.contains("danger") ? "stop" : "start";
    fetch("/api/patrol?action=" + action).then(function(r) { return r.json(); }).then(function(d) {
        updatePatrolUI(d);
        if (d.error) log("Patrol: " + d.error);
    });
}

function formatTime(sec) {
    var h = Math.floor(sec / 3600);
    var m = Math.floor((sec % 3600) / 60);
    var s = sec % 60;
    if (h > 0) return h + "h " + m + "m " + s + "s";
    if (m > 0) return m + "m " + s + "s";
    return s + "s";
}

function updatePatrolUI(d) {
    var btn = document.getElementById("btnPatrol");
    var status = document.getElementById("patrolStatus");
    if (d.running) {
        btn.textContent = "Stop Patrol";
        btn.classList.add("danger");
        status.style.display = "block";
        var pos = d.current_pos || "";
        var remaining = Math.round(d.dwell_remaining || 0);
        var total = Math.round(d.dwell_total || 0);
        var pct = total > 0 ? Math.round(((total - remaining) / total) * 100) : 0;
        // Update position dots
        var posNum = pos ? parseInt(pos.replace("pos", ""), 10) : 0;
        for (var i = 1; i <= 4; i++) {
            var dot = document.getElementById("pp" + i);
            if (!dot) continue;
            dot.className = "patrol-dot";
            if (i === posNum) dot.classList.add("active");
            // Mark skipped positions (time=0) if config is loaded
            if (getPatrolSeconds(i) <= 0) dot.classList.add("skipped");
        }
        // Update label and progress bar
        var label = document.getElementById("patrolLabel");
        var bar = document.getElementById("patrolBar");
        if (pos) {
            label.textContent = "\u2192 Pos " + posNum + "  " + formatTime(remaining);
        } else {
            label.textContent = "Starting...";
        }
        if (bar) bar.style.width = pct + "%";
        if (!_patrolTimer) {
            _patrolTimer = setInterval(pollPatrolStatus, 2000);
        }
    } else {
        btn.textContent = "Start Patrol";
        btn.classList.remove("danger");
        status.style.display = "none";
        if (_patrolTimer) { clearInterval(_patrolTimer); _patrolTimer = null; }
    }
}

function pollPatrolStatus() {
    fetch("/api/patrol?action=status").then(function(r) { return r.json(); }).then(function(d) {
        updatePatrolUI(d);
    }).catch(function() {});
}

function loadPatrolConfig() {
    fetch("/api/patrol?action=config").then(function(r) { return r.json(); }).then(function(d) {
        updatePatrolUI(d);
        var cfg = d.config || {};
        var positions = cfg.positions || [];
        for (var i = 0; i < positions.length; i++) {
            setPatrolHMS(i + 1, positions[i].dwell || 0);
        }
        var rep = document.getElementById("patrolRepeat");
        if (rep) rep.checked = cfg.repeat !== false;
    }).catch(function() {});
}

function fillSelect(el, max) {
    for (var v = 0; v <= max; v++) {
        var opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        el.appendChild(opt);
    }
}

function initPatrolSelects() {
    for (var i = 1; i <= 4; i++) {
        fillSelect(document.getElementById("patrolH" + i), 23);
        fillSelect(document.getElementById("patrolM" + i), 59);
        fillSelect(document.getElementById("patrolS" + i), 59);
    }
}

function getPatrolSeconds(i) {
    var h = parseInt(document.getElementById("patrolH" + i).value) || 0;
    var m = parseInt(document.getElementById("patrolM" + i).value) || 0;
    var s = parseInt(document.getElementById("patrolS" + i).value) || 0;
    return h * 3600 + m * 60 + s;
}

function setPatrolHMS(i, totalSec) {
    var h = Math.floor(totalSec / 3600);
    var m = Math.floor((totalSec % 3600) / 60);
    var s = totalSec % 60;
    var eh = document.getElementById("patrolH" + i);
    var em = document.getElementById("patrolM" + i);
    var es = document.getElementById("patrolS" + i);
    if (eh) eh.value = h;
    if (em) em.value = m;
    if (es) es.value = s;
}

function savePatrolConfig() {
    var positions = [];
    for (var i = 1; i <= 4; i++) {
        positions.push({"name": "pos" + i, "dwell": getPatrolSeconds(i)});
    }
    var repeat = document.getElementById("patrolRepeat").checked;
    fetch("/api/patrol?action=config&positions=" + encodeURIComponent(JSON.stringify(positions)) + "&repeat=" + repeat)
        .then(function(r) { return r.json(); })
        .then(function(d) { log("Patrol config saved"); });
}

function init() {
    // Bind PTZ hold-to-move events (mouse + touch)
    document.querySelectorAll('[data-ptz]').forEach(function(btn) {
        var cmd = btn.getAttribute('data-ptz');
        btn.addEventListener('mousedown', function(e) { e.preventDefault(); ptzDown(cmd); });
        btn.addEventListener('mouseup', function() { ptzUp(); });
        btn.addEventListener('mouseleave', function() { ptzUp(); });
        btn.addEventListener('touchstart', function(e) { e.preventDefault(); ptzDown(cmd); });
        btn.addEventListener('touchend', function(e) { e.preventDefault(); ptzUp(); });
    });

    startView();
    loadImageSettings();
    loadVideoSettings();
    loadSettings();
    loadIR();
    loadOSD();
    checkRecordingStatus();
    initPatrolSelects();
    loadPatrolConfig();
    send("getPTZSpeed", null, function(r) {
        if (r.speed !== undefined) {
            var el = document.getElementById("selPtzSpeed");
            if (el) el.value = r.speed;
        }
    });
    send("getAudioVolume", null, function(r) {
        if (r.volume) setVal("slVolume", r.volume);
    });
}
</script>
</head>
<body onload="init()">

<div id="topbar">
    <h1>NerdCam</h1>
    <span id="statusText" class="stopped">...</span>
</div>

<div id="main">
    <div id="viewer">
        <img id="camImage" alt="Camera feed" />
        <video id="camVideo" autoplay muted playsinline style="display:none"></video>
    </div>

    <div id="sidebar">
        <!-- PTZ -->
        <div class="panel">
            <h3 onclick="togglePanel(this)">Pan / Tilt</h3>
            <div class="panel-body">
                <div id="ptz">
                    <button data-ptz="ptzMoveTopLeft">&#8598;</button>
                    <button data-ptz="ptzMoveUp">&#8593;</button>
                    <button data-ptz="ptzMoveTopRight">&#8599;</button>
                    <button data-ptz="ptzMoveLeft">&#8592;</button>
                    <button onclick="ptzHome()" class="home" title="Return to home position. Brightness may shift as the camera adjusts auto-exposure to the new scene.">HOME</button>
                    <button data-ptz="ptzMoveRight">&#8594;</button>
                    <button data-ptz="ptzMoveBottomLeft">&#8601;</button>
                    <button data-ptz="ptzMoveDown">&#8595;</button>
                    <button data-ptz="ptzMoveBottomRight">&#8600;</button>
                </div>
                <div class="setting">
                    <label>Speed</label>
                    <select id="selPtzSpeed" onchange="send('setPTZSpeed','speed='+this.value)">
                        <option value="0">Fastest</option>
                        <option value="1">Fast</option>
                        <option value="2" selected>Normal</option>
                        <option value="3">Slow</option>
                        <option value="4">Slowest</option>
                    </select>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="gotoPreset('pos1')">Pos 1</button>
                    <button class="btn" onclick="gotoPreset('pos2')">Pos 2</button>
                    <button class="btn" onclick="gotoPreset('pos3')">Pos 3</button>
                    <button class="btn" onclick="gotoPreset('pos4')">Pos 4</button>
                </div>
                <a href="#" onclick="var s=document.getElementById('presetSaveSection');s.style.display=s.style.display==='none'?'block':'none';this.textContent=s.style.display==='none'?'Edit presets...':'Hide presets';return false" style="font-size:0.65em;color:#e94560;display:block;margin:3px 0;">Edit presets...</a>
                <div id="presetSaveSection" style="display:none">
                    <div class="btn-row">
                        <button class="btn danger" onclick="if(confirm('Overwrite Pos 1?'))savePreset('pos1')">Save 1</button>
                        <button class="btn danger" onclick="if(confirm('Overwrite Pos 2?'))savePreset('pos2')">Save 2</button>
                    </div>
                    <div class="btn-row">
                        <button class="btn danger" onclick="if(confirm('Overwrite Pos 3?'))savePreset('pos3')">Save 3</button>
                        <button class="btn danger" onclick="if(confirm('Overwrite Pos 4?'))savePreset('pos4')">Save 4</button>
                    </div>
                </div>
                <div style="border-top:1px solid #0f3460;margin-top:6px;padding-top:6px;">
                    <div style="font-size:0.68em;color:#e94560;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Patrol</div>
                    <div class="btn-row">
                        <button class="btn" id="btnPatrol" onclick="togglePatrol()">Start Patrol</button>
                    </div>
                    <div id="patrolStatus" style="font-size:0.65em;margin-top:4px;display:none;">
                        <div style="display:flex;gap:4px;margin-bottom:3px;" id="patrolPosRow">
                            <span class="patrol-dot" id="pp1">1</span>
                            <span class="patrol-dot" id="pp2">2</span>
                            <span class="patrol-dot" id="pp3">3</span>
                            <span class="patrol-dot" id="pp4">4</span>
                        </div>
                        <div id="patrolLabel" style="color:#ccc;margin-bottom:2px;"></div>
                        <div style="background:#1a1a2e;border-radius:2px;height:4px;">
                            <div id="patrolBar" style="background:#e94560;height:100%;border-radius:2px;width:0%;transition:width 0.5s;"></div>
                        </div>
                    </div>
                    <a href="#" onclick="var s=document.getElementById('patrolConfigSection');s.style.display=s.style.display==='none'?'block':'none';this.textContent=s.style.display==='none'?'Configure patrol...':'Hide config';return false" style="font-size:0.65em;color:#e94560;display:block;margin:3px 0;">Configure patrol...</a>
                    <div id="patrolConfigSection" style="display:none">
                        <div class="patrol-time-row"><span class="patrol-time-label">P1</span><div class="patrol-time-inputs"><select id="patrolH1"></select><span>h</span><select id="patrolM1"></select><span>m</span><select id="patrolS1"></select><span>s</span></div></div>
                        <div class="patrol-time-row"><span class="patrol-time-label">P2</span><div class="patrol-time-inputs"><select id="patrolH2"></select><span>h</span><select id="patrolM2"></select><span>m</span><select id="patrolS2"></select><span>s</span></div></div>
                        <div class="patrol-time-row"><span class="patrol-time-label">P3</span><div class="patrol-time-inputs"><select id="patrolH3"></select><span>h</span><select id="patrolM3"></select><span>m</span><select id="patrolS3"></select><span>s</span></div></div>
                        <div class="patrol-time-row"><span class="patrol-time-label">P4</span><div class="patrol-time-inputs"><select id="patrolH4"></select><span>h</span><select id="patrolM4"></select><span>m</span><select id="patrolS4"></select><span>s</span></div></div>
                        <div class="setting"><label>Repeat</label><input type="checkbox" id="patrolRepeat" checked style="width:auto"></div>
                        <button class="btn" onclick="savePatrolConfig()">Save Config</button>
                        <p style="font-size:0.55em;color:#555;margin-top:2px;">Time = travel + hold. Set all to 0 to skip. Need 2+ active. If the camera doesn't reach a position, increase its time.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- IR -->
        <div class="panel">
            <h3 onclick="togglePanel(this)">Infrared</h3>
            <div class="panel-body">
                <div class="btn-row">
                    <button class="btn" id="btnIrAuto" onclick="setIrMode('auto')">Auto</button>
                    <button class="btn" id="btnIrManual" onclick="setIrMode('manual')">Manual</button>
                </div>
                <div class="btn-row" id="irManualRow" style="display:none">
                    <button class="btn" id="btnIrOn" onclick="setIrLed(true)">ON</button>
                    <button class="btn" id="btnIrOff" onclick="setIrLed(false)">OFF</button>
                </div>
            </div>
        </div>

        <!-- Image -->
        <div class="panel">
            <h3 onclick="togglePanel(this)">Image</h3>
            <div class="panel-body">
                <div class="slider-row">
                    <label>Brightness</label>
                    <input type="range" id="slBright" min="0" max="100" value="50" oninput="setSlider('setBrightness','brightness',this)">
                    <span class="val">50</span>
                </div>
                <div class="slider-row">
                    <label>Contrast</label>
                    <input type="range" id="slContrast" min="0" max="100" value="50" oninput="setSlider('setContrast','constrast',this)">
                    <span class="val">50</span>
                </div>
                <div class="slider-row">
                    <label>Saturation</label>
                    <input type="range" id="slSat" min="0" max="100" value="50" oninput="setSlider('setSaturation','saturation',this)">
                    <span class="val">50</span>
                </div>
                <div class="slider-row">
                    <label>Sharpness</label>
                    <input type="range" id="slSharp" min="0" max="100" value="50" oninput="setSlider('setSharpness','sharpness',this)">
                    <span class="val">50</span>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="send('mirrorVideo','isMirror=1')">Mirror</button>
                    <button class="btn" onclick="send('mirrorVideo','isMirror=0')">Normal</button>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="send('flipVideo','isFlip=1')">Flip</button>
                    <button class="btn" onclick="send('flipVideo','isFlip=0')">Normal</button>
                </div>
            </div>
        </div>

        <!-- Video Settings -->
        <div class="panel collapsed">
            <h3 onclick="togglePanel(this)">Video Settings</h3>
            <div class="panel-body">
                <button class="btn" onclick="loadVideoSettings()">Reload from camera</button>
                <div class="setting">
                    <label>Resolution</label>
                    <select id="selRes" onchange="applyVideoParam('resolution',this.value)">
                        <option value="7">1080p</option>
                        <option value="0">720p</option>
                        <option value="1">VGA</option>
                        <option value="2">QVGA</option>
                    </select>
                </div>
                <div class="setting">
                    <label>Framerate</label>
                    <select id="selFps" onchange="applyVideoParam('frameRate',this.value)">
                        <option value="30">30</option>
                        <option value="25">25</option>
                        <option value="20">20</option>
                        <option value="15">15</option>
                        <option value="10">10</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="setting">
                    <label>Bitrate</label>
                    <select id="selBit" onchange="applyVideoParam('bitRate',this.value)">
                        <option value="4194304">4 Mbps</option>
                        <option value="2097152">2 Mbps</option>
                        <option value="1048576">1 Mbps</option>
                        <option value="524288">512 kbps</option>
                        <option value="262144">256 kbps</option>
                    </select>
                </div>
                <div class="setting">
                    <label>RTSP transport</label>
                    <select id="selRtspTransport" onchange="setRtspTransport(this.value)">
                        <option value="udp" selected>UDP (smooth)</option>
                        <option value="tcp">TCP (reliable)</option>
                    </select>
                </div>
                <p style="font-size:0.55em;color:#555;margin-top:1px;">UDP = low latency, may freeze during PTZ. TCP = no freezes, may be choppier.</p>
            </div>
        </div>

        <!-- Motion Detection -->
        <div class="panel collapsed">
            <h3 onclick="togglePanel(this)">Motion Detection</h3>
            <div class="panel-body">
                <p style="font-size:0.65em;color:#e67e22;margin-bottom:5px;">Not fully implemented &mdash; detection works but events are not captured by NerdCam.</p>
                <button class="btn" onclick="send('getMotionDetectConfig')">Get status</button>
                <div class="btn-row">
                    <button class="btn" onclick="motionEnable()">Enable</button>
                    <button class="btn danger" onclick="motionDisable()">Disable</button>
                </div>
                <div class="setting">
                    <label>Sensitivity</label>
                    <select id="selMotionSens" onchange="motionSensitivity(this.value)">
                        <option value="2">High</option>
                        <option value="1" selected>Medium</option>
                        <option value="0">Low</option>
                        <option value="3">Lower</option>
                        <option value="4">Lowest</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Camera Speaker -->
        <div class="panel collapsed">
            <h3 onclick="togglePanel(this)">Camera Speaker</h3>
            <div class="panel-body">
                <p style="font-size:0.65em;color:#7f8c8d;margin-bottom:5px;">Controls the camera's built-in speaker volume. Sending audio to the camera requires a proprietary protocol (not yet supported).</p>
                <div class="slider-row">
                    <label>Speaker vol</label>
                    <input type="range" id="slVolume" min="0" max="100" value="100" oninput="this.nextElementSibling.textContent=this.value;send('setAudioVolume','volume='+this.value)">
                    <span class="val">100</span>
                </div>
            </div>
        </div>

        <!-- OSD Overlay -->
        <div class="panel collapsed">
            <h3 onclick="togglePanel(this)">OSD Overlay</h3>
            <div class="panel-body">
                <div class="btn-row">
                    <button class="btn" id="btnOsdTs" onclick="toggleOSD('ts')">Timestamp: ...</button>
                </div>
                <div class="btn-row">
                    <button class="btn" id="btnOsdDn" onclick="toggleOSD('dn')">Cam Name: ...</button>
                </div>
                <div class="setting">
                    <label>Device name</label>
                    <input type="text" id="inpDevName" style="width:100px" placeholder="NerdCam">
                </div>
                <button class="btn" onclick="setDevName()">Set Name</button>
            </div>
        </div>

        <!-- Audio & Recording -->
        <div class="panel">
            <h3 onclick="togglePanel(this)">Audio &amp; Recording</h3>
            <div class="panel-body">
                <div class="btn-row">
                    <button class="btn" id="btnAudio" onclick="toggleAudio()">Enable Mic</button>
                </div>
                <div class="slider-row">
                    <label>Mic gain</label>
                    <input type="range" id="slMicGain" min="10" max="50" value="30" step="1" oninput="updateMicGainDisplay(this.value)">
                    <span class="val" id="micGainVal">3.0</span>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="applyMicGain()">Apply Gain</button>
                </div>
                <div class="setting">
                    <label>Rec codec</label>
                    <select id="selRecCodec" style="width:115px" onchange="setRecCodec(this.value)">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="setting" id="gpuRow" style="display:none">
                    <label>Rec GPU</label>
                    <select id="selRecGpu" style="width:115px" onchange="setRecGpu(this.value)">
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <div class="slider-row">
                    <label>Compress</label>
                    <input type="range" id="slRecComp" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value;debounceRecComp(this.value)">
                    <span class="val">5</span>
                </div>
                <div style="font-size:0.55em;color:#555;margin:-1px 0 2px 70px;" id="compLabel">Balanced (default)</div>
                <div class="btn-row">
                    <button class="btn" id="btnRecord" onclick="toggleRecording()" style="flex:2">Record</button>
                </div>
                <div id="recStatus" style="font-size:0.65em;color:#7f8c8d;margin-top:2px;display:none;">
                    <span id="recTime">00:00</span> &mdash; <span id="recFile"></span>
                </div>
                <p style="font-size:0.6em;color:#555;margin-top:3px;">Saves to: recordings/</p>
            </div>
        </div>

        <!-- Info -->
        <div class="panel collapsed">
            <h3 onclick="togglePanel(this)">Device Info</h3>
            <div class="panel-body">
                <div class="btn-row">
                    <button class="btn" onclick="send('getDevInfo')">Device</button>
                    <button class="btn" onclick="send('getDevState')">State</button>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="send('getWifiConfig')">WiFi</button>
                    <button class="btn" onclick="send('getPortInfo')">Ports</button>
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="send('getIPInfo')">IP Info</button>
                    <button class="btn" onclick="syncTime()">Sync Time</button>
                </div>
            </div>
        </div>

        <!-- Output -->
        <div class="panel">
            <h3>Output</h3>
            <div id="output">Ready.</div>
        </div>
    </div>
</div>

</body>
</html>
